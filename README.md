[![Build Status](https://travis-ci.org/windingtree/wt-contracts.svg?branch=master)](https://travis-ci.org/windingtree/wt-contracts)
[![Coverage Status](https://coveralls.io/repos/github/windingtree/wt-contracts/badge.svg?branch=master)](https://coveralls.io/github/windingtree/wt-contracts?branch=master&v=2.0) [![Greenkeeper badge](https://badges.greenkeeper.io/windingtree/wt-contracts.svg)](https://greenkeeper.io/)

# WT Smart Contracts

Smart contracts of the Winding Tree platform.

## Documentation

![contracts-schema.png](./assets/contracts-schema.png)  

Generated documentation is in the [`docs`](https://github.com/windingtree/wt-contracts/tree/master/docs)
folder and can be generated by running `npm run soldoc`.

There are two main groups of users in the Winding Tree platform - content producers (e. g. Hotels, Airlines)
and content consumers (e. g. OTAs (Online Travel Agencies)).

### Content producers

When a producer wants to participate, they have to do the following:

1. Locate Winding Tree Entrypoint address
1. Prepare off-chain data conforming to the [specification](https://github.com/windingtree/wt-organization-schemas). This specification is conformed with [Decentralized Identifiers (DIDs) standard](https://w3c.github.io/did-core/)
1. Create their organization smart contract (commonly referred to as 0xORG)
    1. Fully custom
        1. Create an implementation of `OrganizationInterface` smart contract.
        1. Deploy the custom implementation.
    1. Using forked version of the `Organization` smart contract
        1. Fork current repository and deploy your own Organization
        1. Use the URI of off-chain data and a keccak256 hash of its contents as initialization parameters
    1. As an Organization owner you can create subsidiaries organizations by calling `createSubsidiary` method 
2. Locate the appropriate Segment Directory address
3. Add their newly created organization of subsidiaries to the segment directory by calling the `add` method

### Content consumers

When a consumer wants to participate, they have to do the following:

1. Locate Winding Tree Entrypoint address
1. Locate the appropriate Segment Directory address
1. Call `getOrganizations` on the Segment Directory.
1. Call `getOrgJsonUri` on every non-zero address returned as an instance of `OrganizationInterface` and crawl the off-chain data
for more information.
1. Call `getOrgJsonHash` on every non-zero address returned as an instance of `OrganizationInterface` and verify that the current
off-chain data contents hash matches the hash published in the smart contract.

If a signed message occurs somewhere in the platform, a content consumer might want to decide
if it was signed by an account associated with the declared Organization. That's when they would
first verify the signature and obtain an address of the signer. In the next step, they have to verify
that the actual signer is registered as an `associatedKey` with the Organization by checking its smart contract.

### Working with content hashes

In order to reduce the attack surface, we require a hash of the off-chain stored data. We assume that it
will not change very frequently, so updating the hash every-so-often won't add a significant cost to the whole operation.
So, how does the hash actually look like? It is a `keccak256` (an Ethereum flavour of `sha3`) of the stringified ORG.JSON.
Let's try an example:

```js
const web3utils = require('web3-utils');
const stringOrgJsonContents = `{
    "@context": "https://windingtree.com/ns/did/v1",
    "id": "did:orgid:0xB4Caa470E33A4cE899C16e6C7E125eA03956e95D",
    "created": "2019-01-01T13:10:02.251Z",
    "updated": "2019-06-03T13:20:06.398Z",
    "publicKey": [...],
    "service": [...],
    "trust": {...},
    "legalEntity": {
        "legalName": "Acme, Corp.",
        "alternativeName": "Acme",
        "legalIdentifier": "US12345567",
        "identifiers": [
            {
                "type": "IATA",
                "value": "123456"
            },
            {...}
        ],
        "legalType": "GmBH",
        "registeredAddress": {...},
        "locations": [...],
        "contacts": [
            {
                "function": "Customer Service",
                "name": "John Smith",
                "phone": "+1234567890",
                "email": "email@spam.com"
            },
            {...}
        ]
    }
}`;
// It is important to work with a textual ORG.JSON and *not* a JSON-parsed and re-serialized form.
// JSON serializers might be producing different outcomes which would result in different hashes.
const hashedOrgJson = web3utils.soliditySha3(stringOrgJsonContents);
console.log(`Put me into 0xORG: ${hashedOrgJson}`);
```

You can also produce `keccak256` hashes in a myriad of other tools, such as
[this one](https://emn178.github.io/online-tools/keccak_256.html).

## Requirements

Node 10 is required for running the tests and contract compilation.

## Installation

```sh
npm install @windingtree/wt-contracts
```

```js
import Organization from '@windingtree/wt-contracts/build/contracts/Organization.json';
// or
import { OrganizationInterface, AbstractSegmentDirectory } from '@windingtree/wt-contracts';
```

## Development

```sh
git clone https://github.com/windingtree/wt-contracts
nvm install
npm install
npm test
```

You can run a specific test with `npm test -- test/segment-directory.js`
or you can generate a coverage report with `npm run coverage`.

Project configuration file is placed here: [.openzeppelin/project.json](.openzeppelin/project.json)  

### Flattener

A flattener script is also available. `npm run flattener` command
will create a flattened version without imports - one file per contract.
This is needed if you plan to use tools like [etherscan verifier](https://etherscan.io/verifyContract)
or [securify.ch](https://securify.ch/).

## Deployment

We are using the upgradeability proxy from [openzeppelin](https://docs.openzeppelin.com/sdk/2.5/)
and the deployment pipeline is using their system as well. You can read more
about the [publishing process](https://docs.openzeppelin.com/sdk/2.5/publish) and
[upgrading](https://docs.openzeppelin.com/sdk/2.5/api/upgrades) in `openzeppelin`
documentation.

If you want to deploy just an `Organization` or `SegmentDirectory` contract separately you will need to use our scripts that can be found in the [./management](./management) folder of this repository [TODO]

In order to interact with "real" networks such as `mainnet`, `ropsten` or others,
you need to setup a `keys.json` file used by [truffle](https://truffleframework.com/)
that does the heavy lifting for openzeppelin.

```json
{
  "mnemonic": "<SEED_PHRASE>",
  "infura_projectid": "<PROJECT_ID>"
}
```

### Upgradeability FAQ

**What does upgradeability mean?**

We can update the logic of Entrypoint, Segment Directory or Organization while keeping their
public address the same and **without touching any data**.

**Who is the proxy admin on mainnet?**
The proxies are administered by a 2/5 multisignature wallet, the ENS address is [proxyowner.windingtree.eth](https://etherscan.io/enslookup?q=proxyowner.windingtree.eth).

**Who is the owner wt contracts deployed on mainnet?**
The WindingTreeEntrypoint, OrganizationFactory and Segments are owned by a 3/5 multisignature wallet, the ENS address is [windingtree.eth](https://etherscan.io/enslookup?q=windingtree.eth).

**Can you change the Organization data structure?**

The Organization owner can, yes. As long as we adhere to
[openzeppelin recommendations](https://docs.openzeppelin.com/sdk/2.5/writing-contracts),
it should be safe. The same applies for Segment Directory and Entrypoint

**Can I switch to the new Organization version?**

If you deployed the (upgradeable) Organization yourself you can do it yourself. If you used a non-upgradeable smart contract implementation, then no.

**Why do I keep getting "revert Cannot call fallback function from the proxy admin" when interacting with Organization?**

This is a documented behaviour of [openzeppelin upgradeability](https://docs.openzeppelin.com/sdk/2.5/faq#why-are-my-getting-the-error-cannot-call-fallback-function-from-the-proxy-admin).
You need to call the proxied Organization contract from a different account than is the proxy owner.

**What happens when you upgrade a Segment Directory?**

The Directory address stays the same, the client software has to
interact with the Directory only with the updated ABI which is distributed
via NPM (under the new version number). No data is lost.

**How do I work with different organization versions on the client?**
That should be possible by using an ABI of `OrganizationInterface` on the client side.  

### Organizations hierarchy

Organizations can have subsidiaries. The subsidiary is like a regular organization but linked with a parent organization and can be managed by a special role - `entityDirector`. This director can use the following methods: `changeOrgJsonUri`, `changeOrgJsonHash`, `changeOrgJsonUriAndHash`, `addAssociatedKey`, `removeAssociatedKey` but cannot transfer organization ownership. Organization ownership transferring, enabling or disabling subsidiaries, changing of the subsidiary director are available only for a parent organization owner (via parent organization interface).  

For the creation of a new subsidiary owner of the organization (or its entity director) should use the following functions of `Organization` contract:
- `createSubsidiary` with parameters: `orgJsonUri` (string type), `orgJsonHash` (bytes32 type), `subsidiaryDirector` (address type). 
- `createSubsidiaryAndAddToDirectory` with parameters: `orgJsonUri` (string type), `orgJsonHash` (bytes32 type), `subsidiaryDirector` (address type), `directory` (address type). This function also will add a new subsidiary organization to the provided directory.  
As a result of the function execution, will be obtained an address of the subsidiary organization.   

The director of the subsidiary has to confirm his ownership using the function `confirmSubsidiaryDirectorOwnership` with parameter `subsidiaryAddress` (address type). Subsidiaries, where the director does not confirm his ownership rights, are not shown in the public list of subsidiaries that available via getter `getSubsisiaries`.  

For the change of the subsidiary status (enabled/disabled) owner of the parent organization can use the function:  
- `toggleSubsidiary` with parameter `subsidiaryAddress` (address type).  
Disabled subsidiaries are not shown in the public subsidiaries list available via getter `getSubsidiaries`.  

For getting the address of the parent organization can be used public getter `parentEntity`.   

For getting the account address of the director can be used public getter  `entityDirector`.  

For getting current information about the subsidiary can be used function `getSubsidiary` with parameter `subsidiaryAddress` (address type). This function will return the following options: `id` - subsidiary address (address type), `state` - subsidiary state (boolean type), `confirmed` - director ownership confirmation status, `director` - account address of the director.  

### Contract upgrade process [TODO]

1. Run `npm run version` and release on NPM. This will also bump the version in `.openzeppelin/project.json` file.
1. Deploy upgraded contracts with `npx openzeppelin push --network development` (use the network which you need).
**The `Organization` implementation used by the Factory is changed in this step**.
1. Upgrade contracts with `./node_modules/.bin/openzeppelin upgrade --network development` (use the network which you need). This
will interactively ask you which contracts to upgrade. If you have changed the interface of Organization, make sure to
upgrade `OrganizationFactory` as well.
1. Upgrade Organization contracts with `node management/upgrade-organizations.js`. Make sure that its setup in a proper way.
You can check the `Organization` implementation address in `zos.<network>.json` file. Also, use the account set as Organization
Factory owner. Only that account can change Organizations' implementation.


### Local testing [TODO]

1. You need to run `npm run dev-net` and you will have an output of your addresses and private keys ready to use like this:
    ```
    Available Accounts
    ==================
    (0) 0xbbc04b7c97846af2dac2d0c115f06d6cdab188d8 (~100 ETH)
    (1) 0xeb3d7449df1453ac074492a9fc73f6aebdfe9b2f (~100 ETH)
    (2) 0x14f016e73a18c5a68c475d2dff17af38f85db6b7 (~100 ETH)
    (3) 0x3e083ef62949f90a6f5f46cd314797fed7fa9468 (~100 ETH)
    (4) 0x994d319557cd049b13de8b78c00d97c5aefec192 (~100 ETH)
    (5) 0x6c44a1706d7e4866fc5fbfc8e7547f0682aa8756 (~100 ETH)
    (6) 0x06a99bd405aec473af091454e93a48fa45d8df85 (~100 ETH)
    (7) 0x2e0bcd1841dafdc2f740a4dfcdbb882be21a383a (~100 ETH)
    (8) 0xb34287e5520e3ae9430c53b624830021eff110db (~100 ETH)
    (9) 0x9d112ca960b447d9046816505ca869e06708759b (~100 ETH)
    ```

    In this example we will use the 0 index account for proxy ownership, the 1 index account for contract ownership and the 2 index account for organization creation and ownership.
    The LifToken address will be 0x0, we dont need it to test locally.
1. Start an openzeppelin session.
    ```bash
    > ./node_modules/.bin/openzeppelin session --network development --from 0xbbc04b7c97846af2dac2d0c115f06d6cdab188d8 --expires 3600
    ```
1. Deploy your contracts. This only uploads the logic, the contracts are not meant to be directly
interacted with.
    ```bash
    > ./node_modules/.bin/openzeppelin push --network development
    ```
1. Create the proxy instances of deployed contracts you can interact with. The `args`
attribute is passed to the initializer function. See documentation of the appropriate contracts
for details. The openzeppelin app might differ for each deployment. You don't need a deployed Lif token
to play with this locally. You can get the ZOS_APP_ADDRESS from the zos dev file inside the .openzeppelin (or root) folder.
    ```bash
    > ./node_modules/.bin/openzeppelin create OrganizationFactory --network development --init initialize --args 0xeb3d7449df1453ac074492a9fc73f6aebdfe9b2f,ZOS_APP_ADDRESS
    > ./node_modules/.bin/openzeppelin create WindingTreeEntrypoint --network development --init initialize --args 0xeb3d7449df1453ac074492a9fc73f6aebdfe9b2f,0x0000000000000000000000000000000000000000,ORG_FACTORY_PROXY_ADDRESS
    > ./node_modules/.bin/openzeppelin create SegmentDirectory --network development --init initialize --args 0xeb3d7449df1453ac074492a9fc73f6aebdfe9b2f,hotels,0x0000000000000000000000000000000000000000
    ```

    These commands will return a network address where you can actually interact with the contracts.
    For a quick test, you can use the openzeppelin sdk, you can get all addresses from the zos file that was created.
    ```bash
    > ./node_modules/.bin/openzeppelin send-tx --network development --to WINDINGTREEENTRYPOINT_PROXY_ADDRESS --method setOrganizationFactory --args ORG_FACTORY_PROXY_ADDRESS --from WT_OWNER
    > ./node_modules/.bin/openzeppelin send-tx --network development --to WINDINGTREEENTRYPOINT_PROXY_ADDRESS --method setSegment --args 'hotels',SEGMENTHOTEL_PROXY_ADDRESS --from 0xeb3d7449df1453ac074492a9fc73f6aebdfe9b2f --from WT_OWNER
    > ./node_modules/.bin/openzeppelin send-tx --network development --to ORGFACTORY_PROXY_ADDRESS --method createAndAddToDirectory --args 'https://windingtree.com','0xd1e15bcea4bbf5fa55e36bb5aa9ad5183a4acdc1b06a0f21f3dba8868dee2c99',SEGMENTHOTEL_PROXY_ADDRESS --from 0x14f016e73a18c5a68c475d2dff17af38f85db6b7
    > ./node_modules/.bin/openzeppelin call --network development --to SEGMENTHOTEL_PROXY_ADDRESS --method getOrganizations
    > ./node_modules/.bin/openzeppelin call --network development --to ORGANIZATION_ADDRESS --method getOrgJsonUri
    > ./node_modules/.bin/openzeppelin call --network development --to ORGANIZATION_ADDRESS --method getOrgJsonUri
    ```

    With these commands we have deployed the Winding Tree core contracts, and register and organization in our local network.
